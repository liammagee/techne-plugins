#!/usr/bin/env node
'use strict';

/**
 * extract-backdrop-from-website.js
 *
 * Extracts CSS layers and HTML markup from machinespirits-website's index.html
 * into plugins/techne-backdrop/ files. This is the reverse-sync: visual layer
 * definitions are authored in the website and extracted into the plugin.
 *
 * Usage:
 *   node scripts/extract-backdrop-from-website.js [path-to-machinespirits-website]
 *
 * Defaults to ~/Dev/machinespirits-website if no path given.
 */

const fs = require('fs');
const path = require('path');
const os = require('os');

const websiteDir = process.argv[2] || path.join(os.homedir(), 'Dev', 'machinespirits-website');
const pkgRoot = path.resolve(__dirname, '..');
const pluginDir = path.join(pkgRoot, 'plugins', 'techne-backdrop');

// Validate inputs
if (!fs.existsSync(websiteDir)) {
  console.error(`Error: website dir not found: ${websiteDir}`);
  process.exit(1);
}

const indexPath = path.join(websiteDir, 'index.html');
if (!fs.existsSync(indexPath)) {
  console.error(`Error: missing ${indexPath}`);
  process.exit(1);
}

const faunaPath = path.join(websiteDir, 'fauna-overlay.js');
if (!fs.existsSync(faunaPath)) {
  console.error(`Error: missing ${faunaPath}`);
  process.exit(1);
}

fs.mkdirSync(pluginDir, { recursive: true });

const indexContent = fs.readFileSync(indexPath, 'utf8');
const lines = indexContent.split('\n');

/**
 * Extract lines between a start marker and a stop marker (inclusive of start line).
 */
function extractBetween(lines, startMarker, stopMarker) {
  const result = [];
  let capturing = false;
  for (const line of lines) {
    if (line.includes(startMarker)) {
      capturing = true;
    }
    if (capturing) {
      if (line.includes(stopMarker) && result.length > 0) {
        break;
      }
      result.push(line);
    }
  }
  return result;
}

// --- 1. Copy fauna-overlay.js ---
fs.copyFileSync(faunaPath, path.join(pluginDir, 'fauna-overlay.js'));

// --- 2. Generate techne-backdrop-layers.css ---
const cssHeader = `/* Techne backdrop layers
   - Shapes layer + rotating shapes + fauna overlay
   - Source of truth is ~/Dev/machinespirits-website
   - Generated by: node scripts/extract-backdrop-from-website.js
*/

`;

const layer4 = extractBetween(lines,
  '/* ========== LAYER 4: GEOMETRIC SHAPES ========== */',
  '/* ========== LAYER 5:');
const layer7 = extractBetween(lines,
  '/* ========== LAYER 7: ROTATING SHAPES ========== */',
  '/* ========== LAYER 8: FAUNA OVERLAY ========== */');
const layer8 = extractBetween(lines,
  '/* ========== LAYER 8: FAUNA OVERLAY ========== */',
  '/* ========== NAVIGATION ========== */');

const cssContent = cssHeader
  + layer4.join('\n') + '\n\n'
  + layer7.join('\n') + '\n\n'
  + layer8.join('\n') + '\n';

fs.writeFileSync(path.join(pluginDir, 'techne-backdrop-layers.css'), cssContent);

// --- 3. Generate techne-backdrop-markup.js ---
const htmlLayer4 = extractBetween(lines,
  '<!-- LAYER 4: Shapes -->',
  '<!-- LAYER 5:');
const htmlLayer7 = extractBetween(lines,
  '<!-- LAYER 7: Rotating shapes -->',
  '<!-- LAYER 8:');
const htmlLayer8 = extractBetween(lines,
  '<!-- LAYER 8: Fauna overlay -->',
  '<!-- NAVIGATION -->');

const markupContent = `/* Techne backdrop markup (synced from ~/Dev/machinespirits-website/index.html)
   Generated by: node scripts/extract-backdrop-from-website.js
*/

window.TECHNE_BACKDROP_LAYERS_HTML = \`
${htmlLayer4.join('\n')}
${htmlLayer7.join('\n')}
${htmlLayer8.join('\n')}
\`;
`;

fs.writeFileSync(path.join(pluginDir, 'techne-backdrop-markup.js'), markupContent);

console.log(`Synced Techne backdrop layers from ${websiteDir}`);
